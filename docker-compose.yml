services:
  compileo-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "8000:8000"
    volumes:
      - compileo_storage:/app/storage
      - compileo_plugins:/app/plugins
      - compileo_hf_models:/app/src/compileo/features/ingestion/hf_models
    environment:
      - COMPILEO_API_KEYS=${COMPILEO_API_KEYS}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app:/home/compileo/.local/lib/python3.12/site-packages
      - COMPILEO_REDIS_HOST=redis
      - COMPILEO_REDIS_PORT=6379
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW}
      - LOG_LEVEL=${LOG_LEVEL}
      - NVIDIA_DISABLE_REQUIRE=true
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - HF_HUB_DOWNLOAD_TIMEOUT=1000
      - HF_HUB_ENABLE_HF_TRANSFER=0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    privileged: true  # Test privileged mode for GPU access
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - compileo-network
    restart: unless-stopped

  compileo-gui:
    build:
      context: .
      dockerfile: Dockerfile.gui.light
    ports:
      - "8501:8501"
    volumes:
      - compileo_storage:/app/storage
      - compileo_plugins:/app/plugins
    environment:
      - API_BASE_URL=${API_BASE_URL}
      - COMPILEO_API_KEYS=${COMPILEO_API_KEYS}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - LOG_LEVEL=${LOG_LEVEL}
      - REDIS_URL=redis://redis:6379/0
      - COMPILEO_REDIS_HOST=redis
      - COMPILEO_REDIS_PORT=6379
      - PYTHONPATH=/app:/home/compileo/.local/lib/python3.12/site-packages
    depends_on:
      - compileo-api
      - redis
    networks:
      - compileo-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - compileo-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --appendonly yes

volumes:
  compileo_storage:
  compileo_plugins:
  compileo_hf_models:
  redis_data:

networks:
  compileo-network:
    driver: bridge